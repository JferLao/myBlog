## 前言
 Chrome、微软的 Edge 以及国内的大部分主流浏览器，都是基于 Chromium 二次开发而来；而 Chrome 是 Google 的官方发行版，特性和 Chromium 基本一样，只存在一些产品层面差异；
再加上 Chrome 是目前世界上使用率最高的浏览器，所以研究 Chrome 是很必要性的。今天就来聊聊chorme的进程和线程。

## 进程和线程
关于进程和线程，我很喜欢阮一峰老师的[进程与线程的一个简单解释](https://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html)一文中的解释
```
- CPU:工厂
- 进程 :工厂的车间
- 线程:车间的工人(一个进程可以包括多个线程)
- 进程的内存空间是共享的:车间的空间是工人们共享的
- 一个线程使用某些共享内存时，其他线程必须等它结束，才能使用这一块内存:一些空间如厕所,里面有人的时候，其他人就不能进去了
- 互斥锁(防止多个线程同时读写某一块内存区域):门口加一把锁
```

![进程和线程](https://www.ruanyifeng.com/blogimg/asset/201304/bg2013042404.jpg)

### 并行处理
>计算机中的并行处理就是同一时刻处理多个任务

```
A = 1+2
B = 20/5
C = 7*8
```

在编写代码的时候，我们可以把这个过程拆分为四个任务：
- 任务 1 是计算 A=1+2；
- 任务 2 是计算 B=20/5；
- 任务 3 是计算 C=7*8；
- 任务 4 是显示最后计算的结果。

正常情况下程序可以使用单线程来处理，也就是分四步按照顺序分别执行这四个任务。如果采用多线程，会怎么样呢？
我们只需分“两步走”：第一步，使用三个线程同时执行前三个任务；第二步，再执行第四个显示任务。

通过对比分析，你会发现用单线程执行需要四步，而使用多线程只需要两步。因此，使用并行处理能大大提升性能。

### 线程和进程
多线程可以并行处理任务，但是**线程不能单独存在，它是由进程来启动和管理的**

>一个进程就是一个程序的运行实例，启动一个程序的时候，操作系统会为程序创建一块内存来存放代码，运行中的数据和一个执行任务的主线程。

![单线程和多线程对比图](https://static001.geekbang.org/resource/image/33/da/3380f0a16c323deda5d3a300804b95da.png)

从图中可以看到，**线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率**。

总结来说，进程和线程之间的关系有以下特点
1. 进程中的任意线程执行出错都会导致整个进程崩溃。
2. 线程之间共享进程中的数据。
3. 当一个进程关闭之后，操作系统会回收进程所占用的内存。
4. 进程之间的内容相互隔离。

### 单进程浏览器时代
> 单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程里,包含网络、插件、JavaScript运行环境、渲染引擎和页面等

![单进程浏览器架构图](https://static001.geekbang.org/resource/image/6d/ca/6ddad2419b049b0eb2a8036f3dfff1ca.png)


单进程浏览器容易造成的问题：
1. 不稳定：插件导致浏览器崩溃和渲染引擎不稳定
2. 不流畅：脚本或者插件使浏览器变卡顿，且可能发生内存泄漏
3. 不安全：恶意插件泄漏电脑信息


### 多进程浏览器时代

#### 早期多进程架构
![早期 Chrome 进程架构图](https://static001.geekbang.org/resource/image/cd/60/cdc9215e6c6377fc965b7fac8c3ec960.png)

2008年Chrome发布时的进程架构：插件运行在单独插件进程中。页面运行在单独渲染的进程中。进程之间依靠IPC机制进行通行。

解决问题：
1. 稳定：进程间相互隔离，使得页面或者插件崩溃不影响其他进程。
2. 流畅：脚本阻塞渲染进程不影响其他功能，仅影响当前页面
3. 安全：安全沙箱引入使得恶意程序无法突破沙箱去获取系统权限。

### 目前多进程架构
![最新chrome进程架构图](https://static001.geekbang.org/resource/image/b6/fc/b61cab529fa31301bde290813b4587fc.png)

浏览器架构变成了：一个浏览器进程+一个网络进程+一个GPU进程+多个渲染进程+多个插件进程

功能：
- 浏览器进程：负责主页面、用户交互、子进程管理和存储等功能。
- 渲染进程：排版引擎Blink和V8引擎都在此，负责将html、css、JavaScript转换为网页
- GPU进程：负责3D图像
- 网络进程：负责加载网络资源加载
- 插件进程：负责插件的运行

所以代开一个页面会加载4个进程就是上面提到除了插件进程之外的四个进程。开启插件也会使用到插件进程。

不过凡事都有两面性，虽然多进程模型提升了浏览器的稳定性、流畅性和安全性，但同样不可避免地带来了一些问题：
- 资源占用变高：进程增多浏览器消耗更多内存资源
- 体系结构变复杂：模块间耦合度高、扩展性差

### 未来面向服务的架构
为了解决这些问题，在 2016 年，Chrome 官方团队使用“面向服务的架构”（Services Oriented Architecture，简称 SOA）的思想设计了新的 Chrome 架构。
也就是说 Chrome 整体架构会朝向现代操作系统所采用的“面向服务的架构” 方向发展，原来的各种模块会被重构成独立的服务（Service），每个服务（Service）都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统，更好实现 Chrome 简单、稳定、高速、安全的目标。
Chrome 最终要把 UI、数据库、文件、设备、网络等模块重构为基础服务，类似操作系统底层服务。

![Chrome“面向服务的架构”进程模型图](https://static001.geekbang.org/resource/image/32/2a/329658fe821252db47b0964037a1de2a.png)

Chrome 正在逐步构建 Chrome 基础服务（Chrome Foundation Service），如果你认为 Chrome 是“便携式操作系统”，那么 Chrome 基础服务便可以被视为该操作系统的“基础”系统服务层。同时 Chrome 还提供灵活的弹性架构，在强大性能设备上会以多进程的方式运行基础服务，但是如果在资源受限的设备上（如下图），Chrome 会将很多服务整合到一个进程中，从而节省内存占用。

![在资源不足的设备上，将服务合并到浏览器进程中](https://static001.geekbang.org/resource/image/a9/76/a9ba86d7b03263fa3997d3733d958176.png)


## 总结
上面就是浏览器和进程之间的一些分享了，如果觉得有帮助可以点个星星支持一下本人。