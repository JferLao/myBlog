# 前言
页面时浏览器的核心,浏览器的所有功能都是服务于页面的,所以这一篇文章来讨论一下，浏览器的页面和页面优化问题。
通常来说，一个页面有三个阶段：**加载阶段、交互阶段和关闭阶段**，而所说的页面优化其实是让页面更快的显示和响应。
那么我们就来看看到底在每个不同阶段发生了什么，做什么能优化页面呢。

# 加载阶段
>加载阶段，是指从发出请求到渲染出完整页面的过程，影响到这个阶段的主要因素有网络和JavaScript脚本。

![加载阶段渲染流水线](https://static001.geekbang.org/resource/image/5d/7b/5d8716586b5f4d719097dca881007a7b.jpg)

上面是加载阶段的流程，我们通过一步一步来看一下。首先在页面加载的开始需要发起网络请求获取所需要的资源文件。

## 网络
我们发起一个 HTTP 请求之后，浏览器首先查找缓存，如果缓存没有命中，那么继续发起 DNS 请求获取 IP 地址，
然后利用 IP 地址和服务器端建立 TCP 连接，再发送 HTTP 请求，等待服务器响应；不过，
如果服务器响应头中包含了重定向的信息，那么整个流程就需要重新再走一遍。
这就是在浏览器中一个 HTTP 请求的基础流程。

![浏览器中 HTTP 请求流程](https://static001.geekbang.org/resource/image/1f/e0/1f4f8c194b02975f6d2848b7b73175e0.png)

在一个HTTP请求的基础流程中，可以在Chrome的控制台看出一个请求的具体时间，再根据每一步进而去作出优化。下面是一个请求的控制台显示详情。

![控制台](https://raw.githubusercontent.com/JferLao/myBlog/master/images/network.jpg)

**Queuing**:指一个浏览器发起一个请求的时候，请求不能马上执行需要排队等待。导致的因素有：
1. *页面资源优先级*：HTML/CSS/JavaScript文件优先级最高，图片/视频/音频等优先级低要让路从而进入排队状态。
2. *浏览器限制*：一个域名限制6个TCP连接，超过连接数时超出部分请求会等待。
3. *磁盘影响*：网络进程为数据分配磁盘空间时新的HTTP请求需要短暂等待磁盘分配结束。

**stalled**：指因受一些因素影响连接过程被推迟。

**Proxy Negotiation**：指使用代理服务器的话，所要处理代理的时间。

**DNS Lookup**：指DNS查询所花费的时间。

**Initial connection/SSL**：指和服务器建立连接的阶段，这包括了建立 TCP 连接所花费的时间；不过如果使用了 HTTPS 协议，
那么还需要一个额外的 SSL 握手时间，这个过程主要是用来协商一些加密信息的。

**Request sent**：指和服务器建好连接后，把浏览器缓冲区的数据发送出去，不关注服务器是否收到。

**Waiting**：指数据发送出去等待接收服务器返回数据的第一个字节的时间

**Content Download**：指接收到第一个字节之后到接收完全部数据的时间。

### 网络优化
上面的指标我们可以优化的地方有：
1. Queuing：这部分我们能优化的主要是**一个域名限制6个TCP连接**这个问题，可以使用**域名分片（ 1 个站点下面的资源放在多个域名下面）** 和**站点升级到HTTP2**
2. Waiting：可以通过提高服务器的处理速度、使用 CDN 来缓存一些静态文件和减少一些不必要的 Cookie 数据信息。
3. Content Download：这部分可以通过减少文件大小来优化。

## DOM
网络传给渲染引擎的HTML文件字节流是无法直接被渲染引擎理解，要转成DOM结构，而在渲染流水线中后面的步骤都会依赖DOM。
所以这一段来讨论下DOM。

首先DOM是表述HTML的数据机构，对于页面有很重要的作用。
1. DOM是生成页面的基础数据结构
2. DOM 提供给 JavaScript 脚本操作的接口
3. DOM提供安全防护

## DOM树生成
HTML字节转成DOM结构依靠**HTML解析器（HTMLParser）模块**，并且**网络进程加载了多少数据，HTML解析器就解析多少数据**。

![字节流转换为 DOM](https://static001.geekbang.org/resource/image/1b/8c/1bfcd419acf6402c20ffc1a5b1909d8c.png)

字节流转换为 DOM 主要分为两个阶段：
1. 第一个阶段，通过分词器将字节流转换为 Token
![生成detoken](https://static001.geekbang.org/resource/image/b1/ac/b16d2fbb77e12e376ac0d7edec20ceac.png)

2. 第二个阶段，Token 解析为 DOM 节点，并将 DOM 节点添加到 DOM 树中
![解析1](https://static001.geekbang.org/resource/image/c4/a6/c4a255a8881ef9d21e419aa010ce24a6.png)
![解析2](https://static001.geekbang.org/resource/image/aa/2e/aabf14cde38b058c5203195db82ec22e.png)

### 影响DOM生成
1. 在DOM解析时如果遇上script标签， HTML 解析器就会暂停 DOM 的解析，JavaScript 引擎介入和执行脚本直到结束。
2. **JavaScript 文件的下载过程会阻塞 DOM 解析**
3. **JavaScript 脚本依赖样式表**（代码里引用了外部CSS 文件，需要等待外部的CSS 文件下载完成和解析生成 CSSOM 对象之后，才能执行 JavaScript 脚本）

### 优化DOM
1. Chrome在浏览器做了很多优化，包括**预解析操作**:(当渲染引擎收到字节流之后，会开启一个预解析线程，用来分析 HTML 文件中包含的 JavaScript、CSS 等相关文件，解析到相关文件之后，预解析线程会提前下载这些文件)

2. 对于js阻塞DOM也可以用**CDN 来加速 JavaScript 文件的加载，压缩 JavaScript 文件的体积**的办法来优化

3. 同时还可以通过JavaScript脚本异步的方法来加载。


## CSS